<template>
        <div class="page" data-name="timeslot">
            <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link icon-only back">
                        <i class="icon f7-icons ios-only">close</i>
                        <i class="icon material-icons md-only">close</i>
                    </a>
                </div>  
                <div class="title">Tranche Horaire</div>
                <div class="right">
                    <a href="#" class="link icon-only" id="btnOKTimeSlot">
                        <i class="icon f7-icons ios-only">check</i>
                        <i class="icon material-icons md-only">check</i>
                    </a>
                </div>
            </div>
            </div>
            <div class="page-content">
                <div class="block">
                    <div class="block-title">Horaires </div>
                    <div class="list no-margin">
                    <ul>
                        <li>
                        <div class="item-content item-input">
                            <div class="item-inner">
                            <div class="item-input-wrap">
                                <input type="text" placeholder="Date Time" readonly="readonly" id="pickerTimeSlot"/>
                            </div>
                            </div>
                        </div>
                        </li>
                    </ul>
                    </div>
                </div>
                <!--
                <div class="block block-strong no-padding no-margin margin-bottom">
                    <div id="pickerContainer"></div>
                </div>
                -->
                <div class="block">
                    <div class="block-title">Récurrence </div>
                    <div class="list">
                        <ul>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbMonday" {{#if timeslot}}{{#if timeslot.monday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Lundi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbTuesday" {{#if timeslot}}{{#if timeslot.tuesday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Mardi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbWednesday" {{#if timeslot}}{{#if timeslot.wednesday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Mercredi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbThursday" {{#if timeslot}}{{#if timeslot.thursday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Jeudi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbFriday" {{#if timeslot}}{{#if timeslot.friday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Vendredi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbSaturday" {{#if timeslot}}{{#if timeslot.saturday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Samedi</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbSunday" {{#if timeslot}}{{#if timeslot.sunday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Dimanche</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbHoliday" {{#if timeslot}}{{#if timeslot.holiday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Vacance</div>
                                </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-checkbox item-content">
                                <!-- Checkbox input -->
                                <input type="checkbox" id="cbDayOff" {{#if timeslot}}{{#if timeslot.nonworkingday}}checked="checked"{{/if}}{{/if}}/>
                                <!-- Checkbox icon -->
                                <i class="icon icon-checkbox"></i>
                                <div class="item-inner">
                                    <!-- Checkbox Title -->
                                    <div class="item-title">Jour Férié</div>
                                </div>
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>
                {{#if timeslot}}
                <div class="block">
                    <div class="block-title">Autres </div>
                    <div class="row">
                        <button id="btnDeleteTimeSlot" class="col button button-fill">Suppression</button>
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
    </template>
    <script>
        return {
            data: function () {
                return {
                };
            },
            on: {
                pageInit: function(e, page) {
                    console.log('pageInit', page.name);
                    var router = app.views.current.router; 
                    // get context ov object
                    var ctx = page.route.context;

                    var pickerStartTime = app.picker.create({
                        //containerEl: '#pickerContainer',
                        inputEl: '#pickerTimeSlot',
                        toolbar: false,
                        rotateEffect: true,
                        
                        value: [ '8', '30', '18', '30'],
                        
                        formatValue: function (values, displayValues) {
                            return 'De ' + displayValues[0] + ' : ' + values[1] + ' à ' + displayValues[2] + ' : ' + values[3];
                        },
                        cols: [
                            {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 23; i++) { arr.push(i); }
                                return arr;
                            })(),
                            textAlign: 'left'
                            },
                            // Divider
                            {
                            divider: true,
                            content: ':',
                            textAlign: 'center'
                            },
                            {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 59; i++) { arr.push(i < 10 ? '0' + i : i); }
                                return arr;
                            })(),
                            textAlign: 'left'
                            },
                            // Divider
                            {
                            divider: true,
                            content: ' à '
                            },
                            {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 23; i++) { arr.push(i); }
                                return arr;
                            })(),
                            textAlign: 'left'
                            },
                            // Divider
                            {
                            divider: true,
                            content: ':',
                            textAlign: 'center'
                            },
                            {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 59; i++) { arr.push(i < 10 ? '0' + i : i); }
                                return arr;
                            })(),
                            textAlign: 'left'
                            }
                        ]
                    });

                    // gestion du bouton Suppresion de la tranche horaire
                    console.log('Create OnClick On Delete');
                    $$('#btnDeleteTimeSlot').on('click', function () { // au click sur le bouton Delete 
                        console.log('On Delete');
                        var ts = page.route.context.timeslot;
                        if (ts) // si c'est une mise à jour (presence du timeslot)
                        {
                            console.log('Supression de la tranche horaire');
                            app.request({
                                'url':'/api/timeslot?id=' + ts.id,
                                'method': 'DELETE',
                                //'data': JSON.stringify(aTimeSlot),
                                //'dataType': 'json',
                                success: function(data, status, xhr) // success
                                {
                                    console.log('On Success');
                                    router.back({ignorecache: true, force: true});    
                                },
                                error: function(xhr, status) // error
                                {
                                    console.log('On Error');
                                },
                                
                            }
                            );
                        }
                    });           
                    // fin btn Suppression

                    // gestion du bouton ok
                    $$('#btnOKTimeSlot').on('click', function () { // au click sur le bouton OK
                        console.log('On Valid');
                        if (ctx.timeslot) // si c'est une mise à jour (parametre childId présent)
                        {
                            console.log('Modification de timeslot');
                            var aTimeslot = {
                                    id: ctx.timeslot.id,
                                    startHour: pickerStartTime.value[0],
                                    startMinute: pickerStartTime.value[1], 
                                    endHour: pickerStartTime.value[2],
                                    endMinute: pickerStartTime.value[3],
                                    monday: $$('#cbMonday').is(":checked") == true,
                                    tuesday: $$('#cbTuesday').is(":checked") === true,
                                    wednesday: $$('#cbWednesday').is(":checked") === true,
                                    thursday: $$('#cbThursday').is(":checked") === true,
                                    friday: $$('#cbFriday').is(":checked") === true,
                                    saturday: $$('#cbSaturday').is(":checked") === true,
                                    sunday: $$('#cbSunday').is(":checked") === true,
                                    holiday: $$('#cbHoliday').is(":checked") === true,
                                    nonworkingday: $$('#cbDayOff').is(":checked") === true,
                            };
                            app.request({
                                'url':'/api/Timeslot',
                                'method': 'PUT',
                                'contentType': 'application/json',
                                'data': JSON.stringify(aTimeslot),
                                'dataType': 'json', 
                                success: function(data, status, xhr)// success
                                {
                                    console.log('On Success');
                                    router.back({ignorecache: true, force: true});
                                },
                                error: function(xhr, status)// error
                                {
                                    console.log('On Error');
                                },
                            });  
                        }
                        else // si c'est un ajout
                        {  
                            console.log('Ajout de timeslot');
                            var aTimeslot = {
                                    childid: router.currentRoute.params.childid,
                                    startHour: pickerStartTime.value[0],
                                    startMinute: pickerStartTime.value[1], 
                                    endHour: pickerStartTime.value[2],
                                    endMinute: pickerStartTime.value[3],
                                    monday: $$('#cbMonday').is(":checked") == true,
                                    tuesday: $$('#cbTuesday').is(":checked") === true,
                                    wednesday: $$('#cbWednesday').is(":checked") === true,
                                    thursday: $$('#cbThursday').is(":checked") === true,
                                    friday: $$('#cbFriday').is(":checked") === true,
                                    saturday: $$('#cbSaturday').is(":checked") === true,
                                    sunday: $$('#cbSunday').is(":checked") === true,
                                    holiday: $$('#cbHoliday').is(":checked") === true,
                                    nonworkingday: $$('#cbDayOff').is(":checked") === true,
                                };
                            app.request.postJSON('/api/Timeslot', aTimeslot, 
                                function(data, status, xhr)// success
                                {
                                    console.log('On Success');
                                    router.back({ignorecache: true, force: true});
                                },
                                function(xhr, status)// error
                                {
                                    console.log('On Error');
                                },
                                'json'
                            ); 
                        }
                    });
                    // fin bouton ok

                    if(ctx.timeslot) // if timeslot is defined
                    {
                        // update time picker
                        var times = [ ctx.timeslot.startHour, ctx.timeslot.startMinute, 
                                      ctx.timeslot.endHour  , ctx.timeslot.endMinute    ];
                        pickerStartTime.setValue(times);
                    }
                } // fin page init   
            }
        };
        
    </script>